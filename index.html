<!DOCTYPE html>
<html>
<head>
    <title>AI Voice Agent</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #status { margin-bottom: 10px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

    <h1>Talk to our AI Agent</h1>
    <p id="status">Status: Initializing...</p>
    <button id="start-call-btn">Start Call</button>

    <script type="module">
        // Import directly from the ESM cloud
        import { RetellWebClient } from "https://esm.sh/retell-client-js-sdk";

        const btn = document.getElementById('start-call-btn');
        const statusText = document.getElementById('status');
        let retellWebClient;

        // 1. Initialize
        try {
            console.log("Initializing SDK from Cloud...");
            retellWebClient = new RetellWebClient();
            
            statusText.innerText = "Status: Ready (SDK Loaded from Cloud)";
            statusText.style.color = "green";
            console.log("SDK Ready");
        } catch (err) {
            console.error("Initialization Error:", err);
            statusText.innerText = "Error: " + err.message;
            statusText.style.color = "red";
        }

        // 2. Button Click
        btn.addEventListener('click', async () => {
            if (!retellWebClient) return alert("SDK not ready!");

            statusText.innerText = "Status: Connecting to n8n...";
            
            try {
                // Your n8n Webhook URL
                const n8nUrl = 'https://n8ncchew617.zeabur.app/webhook/start-webcall'; 

                const response = await fetch(n8nUrl, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`n8n Error: ${response.status}`);
                }

                const data = await response.json();
                statusText.innerText = "Status: Token Received. Starting Call...";

                // 3. Start the Call
                await retellWebClient.startCall({
                    accessToken: data.access_token
                });
                
                statusText.innerText = "Status: Call in Progress ðŸ“ž";
                statusText.style.color = "blue";

            } catch (error) {
                console.error("Call Failed:", error);
                statusText.innerText = "Error: " + error.message;
                statusText.style.color = "red";
            }
        });

        // 4. Handle Events
        retellWebClient.on('call_ended', () => {
            console.log('Call ended');
            statusText.innerText = "Status: Call Ended";
            statusText.style.color = "#555";
        });
    </script>
</body>
</html>
