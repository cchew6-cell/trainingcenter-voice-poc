<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jason Chew's AI Classroom [v3]</title>
    
    <script type="module">
        import { RetellWebClient } from 'https://esm.sh/retell-client-js-sdk@latest?bundle';
        window.RetellWebClient = RetellWebClient;
    </script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 700px; margin: 0 auto; color: #333; padding-bottom: 60px; }
        
        /* HEADER LAYOUT */
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .brand-section { display: flex; align-items: center; gap: 15px; }
        .brand-section h1 { margin: 0; font-size: 24px; line-height: 1.2; }
        .profile-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #4CAF50; background-color: #eee; }
        
        /* LANGUAGE SWITCHER */
        .lang-switcher { font-size: 18px; font-weight: bold; color: #555; cursor: pointer; }
        .lang-option { padding: 0 5px; transition: color 0.3s; }
        .lang-option:hover { color: #000; }
        .lang-option.active { color: #d32f2f; text-decoration: underline; } 
        
        /* FORM STYLES */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        
        /* CHECKBOX STYLES */
        .checkbox-container { display: flex; flex-direction: column; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #ddd; }
        .checkbox-item { display: flex; align-items: flex-start; gap: 10px; font-size: 14px; cursor: pointer; }
        .checkbox-item input[type="checkbox"] { width: auto; margin-top: 3px; }
        #other_input_container { margin-top: 5px; margin-left: 25px; display: none; }
        
        /* BUTTON GROUP */
        .class-button-group { display: flex; gap: 10px; margin-top: 25px; }
        
        button { 
            flex: 1; 
            padding: 15px; cursor: pointer; border: none; color: white; border-radius: 6px; font-size: 16px; font-weight: bold; transition: background 0.3s; 
        }
        
        #callConfirmBtn { background-color: #f44336; } 
        #callConfirmBtn:hover { background-color: #d32f2f; }
        #callConfirmBtn:disabled { background-color: #e57373; cursor: not-allowed; }

        #startChatBtn { background-color: #2196F3; } 
        #startChatBtn:hover { background-color: #1976D2; }
        #startChatBtn:disabled { background-color: #90CAF9; cursor: not-allowed; }

        /* NOTIFICATION BOX */
        #chatHelperText { display: none; margin-top: 15px; padding: 15px; background-color: #e3f2fd; border: 1px solid #2196F3; color: #0d47a1; border-radius: 6px; text-align: center; font-weight: bold; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .contact-info { margin-top: 30px; font-size: 0.85em; color: #666; border-top: 1px solid #eee; padding-top: 10px; text-align: center;}

        /* DISCLAIMER FOOTER */
        .legal-footer { margin-top: 40px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; font-size: 11px; color: #6c757d; line-height: 1.5; text-align: justify; }
        .legal-footer h4 { margin-top: 0; margin-bottom: 8px; font-size: 12px; color: #343a40; text-align: center; }
        .legal-footer strong { color: #555; }

        /* WIDGET STYLING */
        retell-widget { z-index: 9999 !important; transform: scale(1.3); transform-origin: bottom right; right: 20px !important; bottom: 20px !important; }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="brand-section">
            <div class="titles">
                <h1 id="mainTitle">Jason Chew's AI Classroom [v3]</h1>
                <div style="font-size: 0.9em; color: #666;" id="subTitle">Training Course Inquiry Form</div>
            </div>
            <img src="header-image.png" onerror="this.style.display='none'" alt="Jason Chew" class="profile-img"> 
        </div>
        <div class="lang-switcher">
            <span class="lang-option active" onclick="setLanguage('english')" id="langEN">EN</span>
            <span class="lang-option" onclick="setLanguage('malay')" id="langMY">MY</span>
            <span class="lang-option" onclick="setLanguage('chinese')" id="langCN">‰∏≠Êñá</span>
        </div>
    </div>

    <div id="inquiryForm">
        <div class="form-group">
            <label for="name" id="lbl_name">Name *</label>
            <input type="text" id="name" required>
        </div>
        <div class="form-group">
            <label for="email" id="lbl_email">Email *</label>
            <input type="email" id="email" required>
        </div>
        <div class="form-group">
            <label for="mobile" id="lbl_mobile">Mobile Phone Number [example: +6012345678] *</label>
            <input type="tel" id="mobile" required placeholder="+60123456789">
        </div>
        <div class="form-group">
            <label for="budget" id="lbl_budget">Budget *</label>
            <select id="budget" name="budget" required>
                <option value="" disabled selected id="opt_default">Select an option...</option>
                <option value="Below RM 4,000" id="opt_1">Below RM 4,000</option>
                <option value="RM 4,000 to RM 7,000" id="opt_2">RM 4,000 to RM 7,000</option>
                <option value="RM 7,000 to RM 11,000" id="opt_3">RM 7,000 to RM 11,000</option>
            </select>
        </div>
        <div class="form-group">
            <label id="lbl_courses">Please tick the training course(s) that you are interested in: *</label>
            <div class="checkbox-container">
                <label class="checkbox-item"><input type="checkbox" name="course" value="Gemini AI (Half Day)"><span id="lbl_c1">Elevate Enterprise Efficiency With The Power of Gemini AI (Half Day course)</span></label>
                <label class="checkbox-item"><input type="checkbox" name="course" value="Google AI Suite (Full Day)"><span id="lbl_c2">Mastering Google AI Suite For Transformative Office Productivity (Full Day course)</span></label>
                <label class="checkbox-item"><input type="checkbox" name="course" value="Customer Service AI (Half Day)"><span id="lbl_c3">AI-Enhanced Customer Service Excellence (Half Day course)</span></label>
                <label class="checkbox-item"><input type="checkbox" id="chk_other" name="course" value="Other" onchange="toggleOtherInput()"><span id="lbl_other">Other</span></label>
                <div id="other_input_container"><input type="text" id="other_text" placeholder="Please specify..."></div>
            </div>
        </div>
        <div class="class-button-group">
            <button type="button" id="callConfirmBtn">Speak To AI Agent (Call)</button>
            <button type="button" id="startChatBtn">Chat with AI Agent</button>
        </div>
        <div id="chatHelperText">‚úÖ Chat Initialized! Please click the icon in the bottom right corner ‚ÜòÔ∏è</div>
        <div class="contact-info">
            <span id="lbl_contact">Contact:</span> <a href="mailto:JasonChew.HDRCtrainer@gmail.com">JasonChew.HDRCtrainer@gmail.com</a>
        </div>
    </div>

    <div class="legal-footer">
        <h4>JasonChew.HDRCtrainer@gmail.com</h4>
        <p>
            <strong id="lbl_disclaimer_title">Legal Disclaimer:</strong> 
            <span id="lbl_disclaimer_text">This tool is provided for educational and administrative convenience. Users are solely responsible for ensuring that their use of this tool does not breach the copyright, intellectual property rights, or Terms of Service of any target systems.</span>
        </p>
        <p>
            <span id="lbl_owner_disclaimer">Jason Chew's AI Classroom (App Owner) assumes no liability for any copyright infringements, unauthorized data usage, or legal consequences arising from the actions of the user.</span>
        </p>
        <p>
            <strong id="lbl_privacy_title">Privacy Notice:</strong> 
            <span id="lbl_privacy_text">Please be advised that all voice calls and chat sessions may be recorded for training and quality assurance purposes. By using these features, you consent to such recording and data processing.</span>
        </p>
    </div>

    <audio id="ringtonePlayer" loop>
        <source src="ring.mp3" type="audio/mpeg">
        <source src="https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/theme_01.mp3" type="audio/mpeg">
    </audio>

<script>
    // --------------------------------------------------------------------------------
    // 1. CONFIGURATION
    // --------------------------------------------------------------------------------
    const WEBHOOK_URL = "https://n8ncchew617.zeabur.app/webhook/79794821-1cc4-41eb-8012-5aa86bd76dfe"; 
    const RETELL_PUBLIC_KEY = "public_key_19d98735dc1a2a14ca801"; 
    const IDLE_TIMEOUT_MS = 60000; 

    // Global State
    let currentLang = 'english'; 
    let isChatLoaded = false;
    let idleTimer = null;
    
    // Voice Agent IDs
    const VOICE_AGENT_MAPPING = {
        'english': 'agent_f04e08a6c3a28c017b5ece2b0a', 
        'malay':   'agent_5b1878d8340797676edfb17e08',    
        'chinese': 'agent_798042308572cdcdae32b94241'    
    };

    // Chat Agent IDs
    const CHAT_AGENT_MAPPING = {
        'english': 'agent_53bfb2a24ce775fc88923be52e', 
        'malay':   'agent_9b25198e5b056b5412458dbbc6',    
        'chinese': 'agent_57560d7227f800a4a8b449222b'    
    };

    // --- TRANSLATIONS ---
    const translations = {
        english: {
            mainTitle: "Jason Chew's AI Classroom [v3]",
            subTitle: "Training Course Inquiry Form",
            lbl_name: "Name *",
            lbl_email: "Email *",
            lbl_mobile: "Mobile Phone Number [example: +6012345678] *",
            lbl_budget: "Budget *",
            lbl_courses: "Please tick the training course(s) that you are interested in: *",
            lbl_c1: "Elevate Enterprise Efficiency With The Power of Gemini AI (Half Day course)",
            lbl_c2: "Mastering Google AI Suite For Transformative Office Productivity (Full Day course)",
            lbl_c3: "AI-Enhanced Customer Service Excellence (Half Day course)",
            lbl_other: "Other",
            callConfirmBtn: "Speak To AI Agent (Call)",
            startChatBtn: "Chat with AI Agent",
            lbl_contact: "Contact:",
            opt_default: "Select an option...",
            opt_1: "Below RM 4,000",
            opt_2: "RM 4,000 to RM 7,000",
            opt_3: "RM 7,000 to RM 11,000",
            chatNotification: "‚úÖ Chat Initialized! Please click the icon in the bottom right corner ‚ÜòÔ∏è",
            widgetTitle: "Jason Chew AI's Classroom AI Assistant",
            lbl_disclaimer_title: "Legal Disclaimer:",
            lbl_disclaimer_text: "This tool is provided for educational and administrative convenience. Users are solely responsible for ensuring that their use of this tool does not breach the copyright, intellectual property rights, or Terms of Service of any target systems.",
            lbl_owner_disclaimer: "Jason Chew's AI Classroom (App Owner) assumes no liability for any copyright infringements, unauthorized data usage, or legal consequences arising from the actions of the user.",
            lbl_privacy_title: "Privacy Notice:",
            lbl_privacy_text: "Please be advised that all voice calls and chat sessions may be recorded for training and quality assurance purposes. By using these features, you consent to such recording and data processing."
        },
        malay: {
            mainTitle: "Kelas AI Jason Chew [v3]",
            subTitle: "Borang Pertanyaan Kursus Latihan",
            lbl_name: "Nama *",
            lbl_email: "E-mel *",
            lbl_mobile: "Nombor Telefon Bimbit [contoh: +6012345678] *",
            lbl_budget: "Bajet *",
            lbl_courses: "Sila tanda kursus latihan yang anda berminat: *",
            lbl_c1: "Tingkatkan Kecekapan Perusahaan Dengan Kuasa Gemini AI (Kursus Separuh Hari)",
            lbl_c2: "Menguasai Google AI Suite Untuk Produktiviti Pejabat Transformatif (Kursus Penuh Hari)",
            lbl_c3: "Kecemerlangan Perkhidmatan Pelanggan Dipertingkatkan AI (Kursus Separuh Hari)",
            lbl_other: "Lain-lain",
            callConfirmBtn: "Cakap dengan AI Agent (Call)",
            startChatBtn: "Sembang dengan AI Agent",
            lbl_contact: "Hubungi:",
            opt_default: "Sila pilih satu...",
            opt_1: "Bawah RM 4,000",
            opt_2: "RM 4,000 hingga RM 7,000",
            opt_3: "RM 7,000 hingga RM 11,000",
            chatNotification: "‚úÖ Sembang Bermula! Sila klik ikon di penjuru bawah kanan ‚ÜòÔ∏è",
            widgetTitle: "Pembantu AI Kelas AI Jason Chew",
            lbl_disclaimer_title: "Penafian Undang-undang:",
            lbl_disclaimer_text: "Alat ini disediakan untuk kemudahan pendidikan dan pentadbiran. Pengguna bertanggungjawab sepenuhnya untuk memastikan penggunaan alat ini tidak melanggar hak cipta, hak harta intelek, atau Syarat Perkhidmatan mana-mana sistem sasaran.",
            lbl_owner_disclaimer: "Kelas AI Jason Chew (Pemilik Aplikasi) tidak bertanggungjawab atas sebarang pelanggaran hak cipta, penggunaan data tanpa kebenaran, atau akibat undang-undang yang timbul daripada tindakan pengguna.",
            lbl_privacy_title: "Notis Privasi:",
            lbl_privacy_text: "Sila ambil maklum bahawa semua panggilan suara dan sesi sembang mungkin direkodkan untuk tujuan latihan dan jaminan kualiti. Dengan menggunakan ciri-ciri ini, anda bersetuju dengan rakaman dan pemprosesan data tersebut."
        },
        chinese: {
            mainTitle: "Jason ChewÁöÑAIÊô∫ÊÖßÊïôÂÆ§ [v3]",
            subTitle: "ÂüπËÆ≠ËØæÁ®ãÂí®ËØ¢Ë°®",
            lbl_name: "ÂßìÂêç *",
            lbl_email: "ÁîµÂ≠êÈÇÆÁÆ± *",
            lbl_mobile: "ÊâãÊú∫Âè∑Á†Å [‰æãÂ¶Ç: +6012345678] *",
            lbl_budget: "È¢ÑÁÆó *",
            lbl_courses: "ËØ∑ÂãæÈÄâÊÇ®ÊÑüÂÖ¥Ë∂£ÁöÑÂüπËÆ≠ËØæÁ®ãÔºö*",
            lbl_c1: "Âà©Áî® Gemini AI ÊèêÂçá‰ºÅ‰∏öÊïàÁéá (ÂçäÂ§©ËØæÁ®ã)",
            lbl_c2: "ÊéåÊè° Google AI Suite ÂÆûÁé∞ÂäûÂÖ¨Áîü‰∫ßÂäõÂèòÈù© (ÂÖ®Â§©ËØæÁ®ã)",
            lbl_c3: "AI Â¢ûÂº∫ÂûãÂçìË∂äÂÆ¢Êà∑ÊúçÂä° (ÂçäÂ§©ËØæÁ®ã)",
            lbl_other: "ÂÖ∂‰ªñ",
            callConfirmBtn: "‰∏é AI Agent ÈÄöËØù (Êã®Êâì)",
            startChatBtn: "‰∏é AI Agent ÊñáÂ≠óËÅäÂ§©",
            lbl_contact: "ËÅîÁ≥ªÊñπÂºè:",
            opt_default: "ËØ∑ÈÄâÊã©...",
            opt_1: "RM 4,000 ‰ª•‰∏ã",
            opt_2: "RM 4,000 Ëá≥ RM 7,000",
            opt_3: "RM 7,000 Ëá≥ RM 11,000",
            chatNotification: "‚úÖ ËÅäÂ§©Â∑≤ÂêØÂä®ÔºÅËØ∑ÁÇπÂáªÂè≥‰∏ãËßíÁöÑÂõæÊ†á ‚ÜòÔ∏è",
            widgetTitle: "Jason Chew AI Êô∫ÊÖßÊïôÂÆ§ - AI Âä©Êâã",
            lbl_disclaimer_title: "Ê≥ïÂæãÂÖçË¥£Â£∞ÊòéÔºö",
            lbl_disclaimer_text: "Êú¨Â∑•ÂÖ∑‰ªÖ‰æõÊïôËÇ≤ÂíåË°åÊîø‰æøÂà©‰ΩøÁî®„ÄÇÁî®Êà∑Ëá™Ë°åË¥üË¥£Á°Æ‰øù‰ΩøÁî®Êú¨Â∑•ÂÖ∑‰∏ç‰ºö‰æµÁäØ‰ªª‰ΩïÁõÆÊ†áÁ≥ªÁªüÁöÑÁâàÊùÉ„ÄÅÁü•ËØÜ‰∫ßÊùÉÊàñÊúçÂä°Êù°Ê¨æ„ÄÇ",
            lbl_owner_disclaimer: "Jason Chew AI Êô∫ÊÖßÊïôÂÆ§ÔºàÂ∫îÁî®ÊâÄÊúâËÄÖÔºâ‰∏çÂØπ‰ªª‰ΩïÁâàÊùÉ‰æµÊùÉ„ÄÅÊú™ÁªèÊéàÊùÉÁöÑÊï∞ÊçÆ‰ΩøÁî®ÊàñÂõ†Áî®Êà∑Ë°å‰∏∫ÂºïËµ∑ÁöÑÊ≥ïÂæãÂêéÊûúÊâøÊãÖË¥£‰ªª„ÄÇ",
            lbl_privacy_title: "ÈöêÁßÅÂ£∞ÊòéÔºö",
            lbl_privacy_text: "ËØ∑Ê≥®ÊÑèÔºåÊâÄÊúâÁöÑËØ≠Èü≥ÈÄöËØùÂíåËÅäÂ§©ËÆ∞ÂΩïÂèØËÉΩ‰ºöË¢´ÂΩïÂà∂ÔºåÁî®‰∫éÂüπËÆ≠ÂíåË¥®Èáè‰øùËØÅ„ÄÇ‰ΩøÁî®Ëøô‰∫õÂäüËÉΩÂç≥Ë°®Á§∫ÊÇ®ÂêåÊÑèÊ≠§Á±ªÂΩïÈü≥ÂíåÊï∞ÊçÆÂ§ÑÁêÜ„ÄÇ"
        }
    };

    // --- LANGUAGE SWITCHING ---
    function setLanguage(lang) {
        currentLang = lang;
        const t = translations[lang];

        document.getElementById('mainTitle').innerText = t.mainTitle;
        document.getElementById('subTitle').innerText = t.subTitle;
        document.getElementById('lbl_name').innerText = t.lbl_name;
        document.getElementById('lbl_email').innerText = t.lbl_email;
        document.getElementById('lbl_mobile').innerText = t.lbl_mobile;
        document.getElementById('lbl_budget').innerText = t.lbl_budget;
        document.getElementById('lbl_contact').innerText = t.lbl_contact;
        document.getElementById('opt_default').innerText = t.opt_default;
        document.getElementById('opt_1').innerText = t.opt_1;
        document.getElementById('opt_2').innerText = t.opt_2;
        document.getElementById('opt_3').innerText = t.opt_3;
        
        document.getElementById('lbl_courses').innerText = t.lbl_courses;
        document.getElementById('lbl_c1').innerText = t.lbl_c1;
        document.getElementById('lbl_c2').innerText = t.lbl_c2;
        document.getElementById('lbl_c3').innerText = t.lbl_c3;
        document.getElementById('lbl_other').innerText = t.lbl_other;

        // Footer & Notification Updates
        document.getElementById('chatHelperText').innerText = t.chatNotification;
        document.getElementById('lbl_disclaimer_title').innerText = t.lbl_disclaimer_title;
        document.getElementById('lbl_disclaimer_text').innerText = t.lbl_disclaimer_text;
        document.getElementById('lbl_owner_disclaimer').innerText = t.lbl_owner_disclaimer;
        document.getElementById('lbl_privacy_title').innerText = t.lbl_privacy_title;
        document.getElementById('lbl_privacy_text').innerText = t.lbl_privacy_text;

        const cBtn = document.getElementById('callConfirmBtn');
        const chatBtn = document.getElementById('startChatBtn');
        if(!cBtn.disabled) cBtn.innerText = t.callConfirmBtn;
        if(!chatBtn.disabled) chatBtn.innerText = t.startChatBtn;

        document.querySelectorAll('.lang-option').forEach(el => el.classList.remove('active'));
        if(lang === 'english') document.getElementById('langEN').classList.add('active');
        if(lang === 'malay') document.getElementById('langMY').classList.add('active');
        if(lang === 'chinese') document.getElementById('langCN').classList.add('active');

        if (isChatLoaded) loadChatWidget(); 
    }

    // --- HELPER: GET SELECTED COURSES ---
    function getSelectedCoursesString() {
        let selectedCourses = [];
        document.querySelectorAll('input[name="course"]:checked').forEach((chk) => {
            if (chk.value === "Other") {
                const txt = document.getElementById('other_text').value.trim();
                selectedCourses.push(txt ? "Other: " + txt : "Other");
            } else selectedCourses.push(chk.value);
        });
        return selectedCourses.length > 0 ? selectedCourses.join(", ") : "General Inquiry";
    }

    // --- SAFE CHAT WIDGET LOADER (Corrected) ---
    function loadChatWidget() {
        const agentId = CHAT_AGENT_MAPPING[currentLang];
        const widgetTitle = translations[currentLang].widgetTitle; 

        // 1. Prepare Data
        const formData = {
            "customer_name": document.getElementById('name').value || "Guest",
            "customer_email": document.getElementById('email').value || "Not Provided",
            "customer_phone": document.getElementById('mobile').value || "Not Provided",
            "budget_requirement": document.getElementById('budget').value || "Not Specified",
            "course_requirement": getSelectedCoursesString()
        };
        const jsonVars = JSON.stringify(formData);
        console.log("üöÄ INJECTING VARIABLES:", formData);

        // 2. Load the Script ONLY IF it's not already there
        if (!document.getElementById('retell-widget')) {
            const script = document.createElement('script');
            script.id = 'retell-widget';
            script.src = 'https://dashboard.retellai.com/retell-widget.js';
            script.type = 'module';
            script.async = true;
            document.body.appendChild(script);
        }

        // 3. Manually Create/Update the Widget Element
        // Remove old widget instance if exists
        const oldWidget = document.querySelector('retell-widget');
        if (oldWidget) oldWidget.remove();

        // Create new widget instance with fresh variables
        const widget = document.createElement('retell-widget');
        widget.setAttribute('data-public-key', RETELL_PUBLIC_KEY);
        widget.setAttribute('data-agent-id', agentId);
        widget.setAttribute('data-title', widgetTitle);
        widget.setAttribute('data-customer-id', "user_" + Date.now());
        widget.setAttribute('data-dynamic-variables', jsonVars);
        widget.setAttribute('data-retell-llm-dynamic-variables', jsonVars);

        // Append the widget to the body
        document.body.appendChild(widget);

        // 4. Update UI
        setTimeout(() => {
            document.getElementById('startChatBtn').style.display = 'none';
            document.getElementById('chatHelperText').style.display = 'block';
            isChatLoaded = true;
            resetIdleTimer();
        }, 500);
    }

    // --- IDLE TIMER ---
    function startIdleWatcher() {
        if (idleTimer) clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
            if (isChatLoaded) endChatSession(true); 
        }, IDLE_TIMEOUT_MS);
    }
    function resetIdleTimer() {
        if (isChatLoaded) startIdleWatcher();
    }
    function endChatSession(showAlert) {
        // Corrected: Remove ONLY the widget element, keep the script tag
        const oldWidget = document.querySelector('retell-widget');
        if (oldWidget) oldWidget.remove();
        
        isChatLoaded = false;
        if (idleTimer) clearTimeout(idleTimer);
        const chatBtn = document.getElementById('startChatBtn');
        const t = translations[currentLang];
        chatBtn.style.display = 'inline-block';
        chatBtn.innerText = t.startChatBtn;
        chatBtn.disabled = false;
        document.getElementById('chatHelperText').style.display = 'none';
        if (showAlert) alert("Chat session ended due to inactivity (1 minute).");
    }
    ['mousemove', 'keydown', 'click', 'scroll'].forEach(evt => document.addEventListener(evt, resetIdleTimer));

    window.toggleOtherInput = function() {
        const chk = document.getElementById('chk_other');
        document.getElementById('other_input_container').style.display = chk.checked ? 'block' : 'none';
    };

    function validateForm() {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const budget = document.getElementById('budget').value;
        let selectedCourses = false;
        document.querySelectorAll('input[name="course"]:checked').forEach(() => selectedCourses = true);
        if (!name || !email || !budget) { alert("Please fill out all required fields."); return false; }
        if (!selectedCourses) { alert("Please tick at least one course."); return false; }
        return true;
    }

    document.getElementById('startChatBtn').addEventListener('click', () => {
        if (validateForm()) {
            const chatBtn = document.getElementById('startChatBtn');
            chatBtn.innerText = "Initializing Chat...";
            chatBtn.disabled = true;
            loadChatWidget();
        }
    });

    document.getElementById('callConfirmBtn').addEventListener('click', () => sendFormData(getFormData('Call To Confirm (AI Agent)')));

    function getFormData(actionType) {
        const selectedAgentId = VOICE_AGENT_MAPPING[currentLang];
        return {
            timestamp: new Date().toISOString(),
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            mobile: document.getElementById('mobile').value,
            budget: document.getElementById('budget').value,
            requirements: getSelectedCoursesString(),
            formAction: actionType, 
            chosen_agent_id: selectedAgentId,
            language_preference: currentLang
        };
    }
    
    function stopRingtone() {
        const ringtone = document.getElementById('ringtonePlayer');
        if(ringtone && !ringtone.paused) { ringtone.pause(); ringtone.currentTime = 0; }
    }

    async function sendFormData(data) {
        if (!validateForm()) return;
        const cBtn = document.getElementById('callConfirmBtn');
        cBtn.disabled = true;
        cBtn.innerText = "Connecting...";
        try {
            const response = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            let responseData = await response.json().catch(() => ({}));
            let accessToken = null;
            if (Array.isArray(responseData) && responseData.length > 0) accessToken = responseData[0].access_token; 
            else if (responseData.access_token) accessToken = responseData.access_token; 
            if (accessToken) {
                const ringtone = document.getElementById('ringtonePlayer');
                if(ringtone) { ringtone.volume = 0.5; ringtone.currentTime = 0; ringtone.play().catch(e => console.log("Auto-play prevented:", e)); }
                if (typeof window.RetellWebClient === 'undefined') { alert("SDK Loading... try again."); resetButtons(); return; }
                const retellWebClient = new window.RetellWebClient();
                let isAgentSpeaking = false; 
                retellWebClient.on("call_started", () => { cBtn.innerText = "Speaking..."; setTimeout(() => { if(!isAgentSpeaking) stopRingtone(); }, 60000); });
                retellWebClient.on("update", (update) => { if (!isAgentSpeaking) { stopRingtone(); isAgentSpeaking = true; } });
                retellWebClient.on("call_ended", () => { stopRingtone(); resetButtons(); alert("Call finished. Thank you!"); });
                retellWebClient.on("error", (error) => { stopRingtone(); console.error("Retell Error:", error); alert("Connection Error."); resetButtons(); });
                await retellWebClient.startCall({ accessToken: accessToken });
            } else { alert("Submission failed. No Token."); resetButtons(); }
        } catch (error) { console.error(error); stopRingtone(); alert("Network Error."); resetButtons(); }
    }

    function resetButtons() {
        const cBtn = document.getElementById('callConfirmBtn');
        const t = translations[currentLang];
        cBtn.disabled = false;
        cBtn.innerText = t.callConfirmBtn;
    }
</script>
</body>
</html>
