<script>
        // CONFIGURATION - Use your TEST URL for now as it works best
        const WEBHOOK_URL = "https://n8nchew617.zeabur.app/webhook-test/810caca4-0740-48af-9494-535db7f9be7e";

        const submitBtn = document.getElementById('submitBtn');
        const callToConfirmBtn = document.getElementById('callToConfirmBtn');

        function getFormData(actionType) {
            return {
                timestamp: new Date().toISOString(), // Generate time on client side
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                mobile: document.getElementById('mobile').value,
                budget: document.getElementById('budget').value,
                requirements: document.getElementById('requirements').value,
                formAction: actionType // This is the KEY variable for your IF node
            };
        }

        // Reusable function to send data to n8n
        async function sendToN8n(data) {
            // Convert to URLSearchParams for 'no-cors' mode
            const formBody = new URLSearchParams();
            for (const key in data) {
                formBody.append(key, data[key]);
            }

            await fetch(WEBHOOK_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formBody
            });
        }

        // --- SUBMIT BUTTON LOGIC ---
        submitBtn.addEventListener('click', async function() {
            const data = getFormData('submit'); // Tag as 'submit'
            
            if (!data.name || !data.email || !data.mobile) {
                alert("Please fill in all required fields.");
                return;
            }

            submitBtn.textContent = "Sending...";
            submitBtn.disabled = true;

            try {
                await sendToN8n(data); // Send to n8n
                alert("Form submitted successfully!");
            } catch (error) {
                console.error("Submission Error:", error);
                alert("Submission failed, but we will try to contact you.");
            } finally {
                submitBtn.textContent = "Submit (Log Only)";
                submitBtn.disabled = false;
            }
        });

        // --- CALL BUTTON LOGIC ---
        callToConfirmBtn.addEventListener('click', async function() {
            // 1. Validation
             if (typeof Retail === 'undefined' || !Retail.client) {
                alert('Retail widget not loaded. Please wait.');
                return;
            }
            
            const data = getFormData('call'); // Tag as 'call'
            if (!data.name || !data.mobile) {
                alert("Please fill in Name and Mobile before calling.");
                return;
            }

            // 2. Toggle Call Logic
            const isTalkActive = Retail.client.isTalkActive();

            if (isTalkActive) {
                Retail.client.stopCall();
            } else {
                // 3. Send log to n8n BEFORE starting call
                // We don't await this because we want the call to start immediately
                sendToN8n(data).catch(err => console.error("Log failed", err));

                // 4. Start the AI Call
                Retail.client.startCall({
                    metadata: {
                        name: data.name,
                        email: data.email,
                        mobile: data.mobile
                    }
                });
            }
        });

        // UI Updates for Call Status
        document.addEventListener('retail-call-started', function() {
            callToConfirmBtn.textContent = "End Call";
            callToConfirmBtn.style.backgroundColor = "#dc3545"; 
        });

        document.addEventListener('retail-call-ended', function() {
            callToConfirmBtn.textContent = "Call To Confirm (AI Agent)";
            callToConfirmBtn.style.backgroundColor = "#dc3545"; 
        });

    </script>
